extends layout

block content
  //- h1= title
  //- p Welcome to #{title}

  //- div#map-container
  //-   canvas#container
  .svg-container


  script(src="https://d3js.org/d3.v4.min.js")
  script(src="//d3js.org/topojson.v1.min.js")
  script(src="/javascripts/dist/socket.io.js")
  script.
    var socket = io.connect('http://localhost:3000');
    socket.on('message', function(message) {
      console.log(message);
    });

    socket.on('JSON update', function(json) {
      json = JSON.parse(json);
      console.log(json);
      vis.selectAll("circle.bus").data(json.features).exit().remove();
      vis.selectAll("circle.bus").data(json.features).enter().append("circle")
        .classed("bus", true)
        .attr("r", 6)
        .attr("id", function(d) {
          if (d.properties.DirectionRef === "0") {
            return "green"
          } else if (d.properties.DirectionRef === "1") {
            return "red"
          }
        })
        .style("stroke-width", "3")
        .on("mouseover", function (d) {
          div.transition()
            .duration(200)
            .style("opacity", .9);
          div.html(d.properties.DestinationName + "<br/>" + d.properties.Distances.PresentableDistance + "<br/>" + d.properties.StopPointName + "<br/>" + d.properties.VehicleRef + "<br/>" + d.properties.ProgressRate + "<br/>" + d.properties.DirectionRef)
            .style("left", (d3.event.pageX) + "px")
            .style("top", (d3.event.pageY - 28) + "px");
        })
        .on("mouseout", function (d) {
          div.transition()
            .duration(500)
            .style("opacity", 0);
        });

      vis.selectAll("circle.bus").data(json.features)
        .attr("cx", function(d) {
          console.log(d.geometry.coordinates);
          return projection(d.geometry.coordinates)[0];
        })
        .attr("cy", function(d) {
          return projection(d.geometry.coordinates)[1];
        })
    });
    
  script(src='/javascripts/d3BusMap.js')
